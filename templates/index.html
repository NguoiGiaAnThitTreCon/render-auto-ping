<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Auto Ping — Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background: linear-gradient(135deg,#0f172a,#0b1220); color: #e6eef8; }
      .card { border-radius: 16px; box-shadow: 0 6px 30px rgba(2,6,23,0.6); }
      .small-muted { color: #9fb3d9; }
      .table thead th { color: #cfe3ff; }
      .btn-glow { box-shadow: 0 6px 18px rgba(59,130,246,0.18); }
      pre.log { max-height: 240px; overflow:auto; background:#071025; color:#a8e3ff; padding:12px; border-radius:8px; }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row mb-4">
        <div class="col-md-8 mx-auto">
          <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h3 class="mb-0">Auto Ping Dashboard</h3>
                <div class="small-muted">Ping external sites on schedule — built for Render.com</div>
              </div>
              <div>
                <button class="btn btn-primary btn-glow" data-bs-toggle="modal" data-bs-target="#addModal">+ Add target</button>
              </div>
            </div>

            <div id="targets-area">
              <table class="table table-dark table-striped align-middle">
                <thead>
                  <tr>
                    <th>Label / URL</th>
                    <th>Interval</th>
                    <th>Status</th>
                    <th>Controls</th>
                  </tr>
                </thead>
                <tbody id="targets-tbody">
                  {% for t in targets %}
                  <tr data-id="{{ t.id }}">
                    <td>
                      <div><strong>{{ t.label }}</strong></div>
                      <div class="small-muted">{{ t.url }}</div>
                    </td>
                    <td>{{ t.interval }}s</td>
                    <td><span class="badge bg-{{ 'success' if t.running else 'secondary' }}">{{ 'Running' if t.running else 'Stopped' }}</span></td>
                    <td>
                      <div class="btn-group">
                        <button class="btn btn-sm btn-outline-light start-btn" data-id="{{ t.id }}">Start</button>
                        <button class="btn btn-sm btn-outline-light stop-btn" data-id="{{ t.id }}">Stop</button>
                        <button class="btn btn-sm btn-outline-light ping-now" data-id="{{ t.id }}">Ping now</button>
                        <button class="btn btn-sm btn-outline-light view-logs" data-id="{{ t.id }}">Logs</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="{{ t.id }}">Delete</button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div id="log-panel" class="mt-3 d-none">
              <h5>Logs</h5>
              <pre id="log-content" class="log"></pre>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Add modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" method="POST" action="/add">
          <div class="modal-header">
            <h5 class="modal-title">Add target to ping</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">URL</label>
              <input name="url" class="form-control" placeholder="https://example.com" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Label (optional)</label>
              <input name="label" class="form-control" placeholder="My site">
            </div>
            <div class="mb-3">
              <label class="form-label">Interval</label>
              <select class="form-select" name="interval">
                <option value="5">5 seconds</option>
                <option value="10">10 seconds</option>
                <option value="30">30 seconds</option>
                <option value="60">60 seconds</option>
              </select>
              <div class="small-muted mt-1">Choose how often to send GET requests.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      async function apiPost(path){
        const r = await fetch(path, {method:'POST'});
        return r.json();
      }

      document.addEventListener('click', async (e)=>{
        if(e.target.matches('.start-btn')){
          const id = e.target.dataset.id;
          await apiPost('/start/'+id);
          location.reload();
        }
        if(e.target.matches('.stop-btn')){
          const id = e.target.dataset.id;
          await apiPost('/stop/'+id);
          location.reload();
        }
        if(e.target.matches('.ping-now')){
          const id = e.target.dataset.id;
          await apiPost('/ping_now/'+id);
          alert('Ping requested');
        }
        if(e.target.matches('.delete-btn')){
          if(!confirm('Delete this target?')) return;
          const id = e.target.dataset.id;
          await apiPost('/delete/'+id);
          location.reload();
        }
        if(e.target.matches('.view-logs')){
          const id = e.target.dataset.id;
          const res = await fetch('/logs/'+id);
          const data = await res.json();
          const panel = document.getElementById('log-panel');
          const content = document.getElementById('log-content');
          if(data.ok){
            content.textContent = data.logs.map(l=>{
              const d = new Date(l.ts*1000).toLocaleString();
              if(l.status==='ok') return `${d} — ${l.code} (${l.time}s)`;
              return `${d} — ERROR: ${l.error}`;
            }).join('\\n');
            panel.classList.remove('d-none');
            window.scrollTo(0,document.body.scrollHeight);
          }
        }
      });
    </script>
  </body>
</html>
